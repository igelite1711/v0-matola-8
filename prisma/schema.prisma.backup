// Prisma Schema for MATOLA LOGISTICS PLATFORM
// Database: SQLite (Local Development)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id                String   @id @default(cuid())
  phone             String   @unique
  name              String
  email             String?
  whatsapp          String?
  pinHash           String   // bcrypt hashed PIN
  avatar            String?
  role              UserRole
  rating            Float    @default(0)
  totalRatings      Int      @default(0)
  verified          Boolean  @default(false)
  verificationLevel VerificationLevel @default(none)
  preferredLanguage Language @default(en)
  
  // Malawi-specific fields
  communityVouchers String[] // Array of user IDs who vouched
  chiefReference    Json?    // { name, village, district }
  rtoaMembership    String?
  
  // Relationships
  shipments         Shipment[]
  matches           Match[]
  bids              Bid[]
  vehicles          Vehicle[]
  transactions      WalletTransaction[]
  ratings           Rating[] @relation("UserRatings")
  ratedBy           Rating[] @relation("RatedBy")
  ussdSessions      USSDSession[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  userAchievements  UserAchievement[]
  leaderboardEntries LeaderboardEntry[]
  
  // Transporter-specific (nullable)
  transporterProfile TransporterProfile?
  
  // Shipper-specific (nullable)
  shipperProfile    ShipperProfile?
  
  // Broker-specific (nullable)
  brokerProfile     BrokerProfile?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([phone])
  @@index([role])
  @@index([verificationLevel])
}

enum UserRole {
  shipper
  transporter
  broker
  admin
}

enum VerificationLevel {
  none
  phone
  id
  community
  rtoa
  full
}

enum Language {
  en
  ny
}

// ============================================
// TRANSPORTER PROFILE
// ============================================

model TransporterProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  vehicleType     VehicleType
  vehiclePlate    String
  vehicleCapacity Int
  vehicleMake     String?
  isAvailable     Boolean  @default(true)
  completedTrips  Int      @default(0)
  onTimeRate      Float    @default(1.0)
  preferredRoutes String[]
  hasRefrigeration Boolean @default(false)
  hasGPS          Boolean  @default(false)
  unionMembership UnionMembership?
  cooperativeName String?
  
  // Current location
  currentCity     String?
  currentDistrict String?
  currentRegion   Region?
  currentLat      Float?
  currentLng      Float?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([isAvailable])
  @@index([vehicleType])
}

enum VehicleType {
  pickup
  canter
  small_truck
  medium_truck
  large_truck
  flatbed
  refrigerated
  tanker
}

enum UnionMembership {
  rtoa
  masta
  cooperative
  independent
}

enum Region {
  Northern
  Central
  Southern
}

// ============================================
// VEHICLES
// ============================================

model Vehicle {
  id              String   @id @default(cuid())
  transporterId   String
  transporter     User     @relation(fields: [transporterId], references: [id], onDelete: Cascade)
  
  type            VehicleType
  plate           String
  make            String?
  model           String?
  capacity        Int      // kg
  year            Int?
  registration    String?
  insuranceExpiry DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([transporterId])
  @@index([plate])
}

// ============================================
// SHIPPER PROFILE
// ============================================

model ShipperProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  businessName    String?
  businessType    BusinessType?
  totalShipments  Int      @default(0)
  tpinNumber      String?
  preferredPayment PaymentMethod?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum BusinessType {
  individual
  sme
  corporate
  farmer
  trader
  manufacturer
}

// ============================================
// BROKER PROFILE
// ============================================

model BrokerProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  networkSize       Int      @default(0)
  activeTransporters Int     @default(0)
  activeShippers    Int      @default(0)
  totalCommission   Float    @default(0)
  matchesMade       Int      @default(0)
  specializedRoutes String[]
  specializedCargo  CargoType[]
  operatingRegions  Region[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================
// SHIPMENTS
// ============================================

model Shipment {
  id                String   @id @default(cuid())
  shipperId         String
  shipper           User     @relation(fields: [shipperId], references: [id], onDelete: Cascade)
  reference         String   @unique // ML12345 format
  
  // Origin & Destination
  originCity        String
  originDistrict    String
  originRegion      Region
  originLat         Float?
  originLng         Float?
  originLandmark    String?
  originAdmarc      String?
  
  destinationCity   String
  destinationDistrict String
  destinationRegion Region
  destinationLat    Float?
  destinationLng    Float?
  destinationLandmark String?
  destinationAdmarc String?
  
  // Cargo details
  cargoType         CargoType
  cargoDescription  String
  cargoDescriptionNy String?
  weight            Int      // kg
  length            Float?
  width             Float?
  height            Float?
  
  // Vehicle & Timing
  requiredVehicleType VehicleType
  pickupDate        DateTime
  pickupTimeWindow  String
  deliveryDate      DateTime?
  
  // Pricing
  price             Float
  currency          String   @default("MWK")
  paymentMethod     PaymentMethod
  isBackhaul        Boolean  @default(false)
  backhaulDiscount  Float?
  
  // Status & Tracking
  status            ShipmentStatus @default(draft)
  seasonalCategory  SeasonalCategory?
  specialInstructions String?
  
  // Border crossing
  borderCrossingRequired Boolean @default(false)
  borderPost        String?
  estimatedClearanceHours Int?
  
  // Relationships
  checkpoints       Checkpoint[]
  matches           Match[]
  bids              Bid[]
  transactions      WalletTransaction[]
  disputes          Dispute[]
  ratings           Rating[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([shipperId])
  @@index([status])
  @@index([cargoType])
  @@index([originCity, destinationCity])
  @@index([pickupDate])
  @@index([createdAt])
}

enum CargoType {
  general
  agricultural
  maize
  tobacco
  tea
  sugar
  fertilizer
  construction
  cement
  fuel
  fragile
  perishable
  hazardous
  livestock
}

enum ShipmentStatus {
  draft
  posted
  matched
  confirmed
  picked_up
  in_transit
  at_checkpoint
  at_border
  delivered
  completed
  cancelled
  disputed
}

enum SeasonalCategory {
  maize_harvest
  tobacco_auction
  tea_season
  fertilizer_import
  general
}

enum PaymentMethod {
  cash
  airtel_money
  tnm_mpamba
  bank_transfer
}

// ============================================
// CHECKPOINTS
// ============================================

model Checkpoint {
  id            String   @id @default(cuid())
  shipmentId    String
  shipment      Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  name          String
  city          String
  district      String
  region        Region
  lat           Float?
  lng           Float?
  
  arrivedAt     DateTime?
  departedAt    DateTime?
  notes         String?
  confirmedBy   String?   // "driver" | "shipper" | "automatic"
  
  createdAt     DateTime @default(now())
  
  @@index([shipmentId])
}

// ============================================
// MATCHES
// ============================================

model Match {
  id              String   @id @default(cuid())
  shipmentId      String
  shipment        Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  transporterId   String
  transporter     User     @relation(fields: [transporterId], references: [id], onDelete: Cascade)
  
  matchScore      Float
  isBackhaul      Boolean  @default(false)
  estimatedPickup DateTime
  proposedPrice   Float?
  status          MatchStatus @default(pending)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([shipmentId, transporterId])
  @@index([shipmentId])
  @@index([transporterId])
  @@index([status])
}

enum MatchStatus {
  pending
  accepted
  rejected
  expired
}

// ============================================
// BIDS
// ============================================

model Bid {
  id              String   @id @default(cuid())
  shipmentId      String
  shipment        Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  transporterId   String
  transporter      User     @relation(fields: [transporterId], references: [id], onDelete: Cascade)
  
  proposedPrice   Float
  message         String?
  messageNy       String?
  estimatedPickup DateTime
  status          BidStatus @default(pending)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([shipmentId])
  @@index([transporterId])
  @@index([status])
}

enum BidStatus {
  pending
  accepted
  rejected
  withdrawn
}

// ============================================
// PAYMENTS & WALLET
// ============================================

model WalletTransaction {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shipmentId    String?
  shipment      Shipment? @relation(fields: [shipmentId], references: [id])
  
  type          TransactionType
  amount        Float
  status        TransactionStatus @default(pending)
  method        PaymentMethod
  reference     String   @unique
  description   String
  
  // Metadata
  escrowId      String?
  commissionRate Float?
  netAmount     Float?
  grossAmount   Float?
  
  createdAt     DateTime @default(now())
  completedAt   DateTime?
  
  @@index([userId])
  @@index([shipmentId])
  @@index([status])
  @@index([reference])
  @@index([createdAt])
}

enum TransactionType {
  payment
  payout
  refund
  escrow_hold
  escrow_release
  commission
  tip
}

enum TransactionStatus {
  pending
  completed
  failed
  held
  released
}

// ============================================
// RATINGS
// ============================================

model Rating {
  id              String   @id @default(cuid())
  shipmentId      String
  shipment        Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  fromUserId      String
  fromUser        User     @relation("UserRatings", fields: [fromUserId], references: [id])
  toUserId        String
  toUser          User     @relation("RatedBy", fields: [toUserId], references: [id])
  
  fromRole        UserRole
  toRole          UserRole
  overallRating   Int      // 1-5
  categoryRatings Json     // { punctuality: 5, communication: 4, ... }
  tags            String[]
  review          String?
  
  createdAt       DateTime @default(now())
  
  @@index([shipmentId])
  @@index([toUserId])
  @@index([fromUserId])
}

// ============================================
// DISPUTES
// ============================================

model Dispute {
  id            String   @id @default(cuid())
  shipmentId    String
  shipment      Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  reportedBy    String
  reportedByRole UserRole
  againstUser   String
  againstUserRole UserRole
  
  type          DisputeType
  description   String
  voiceNoteUrl  String?
  images        String[]
  status        DisputeStatus @default(open)
  resolution    String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  resolvedAt   DateTime?
  
  @@index([shipmentId])
  @@index([status])
}

enum DisputeType {
  delayed_delivery
  damaged_goods
  wrong_pickup
  payment_issue
  no_show
  overcharge
  border_delay
  driver_no_show
  cargo_lost
  other
}

enum DisputeStatus {
  open
  investigating
  resolved
  escalated
  closed
}

// ============================================
// USSD SESSIONS
// ============================================

model USSDSession {
  id            String   @id @default(cuid())
  sessionId     String   @unique // Africa's Talking session ID
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  phoneNumber   String
  
  state         String   // State machine state
  context       Json     // Session context data
  stepCount     Int      @default(0)
  language      Language @default(en)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  expiresAt     DateTime // 5 minutes from creation
  
  @@index([sessionId])
  @@index([phoneNumber])
  @@index([expiresAt])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          NotificationType
  title         String
  message       String
  data          Json?    // Additional data (matchId, shipmentId, etc.)
  channels      String[] // ["sms", "whatsapp", "push", "in_app"]
  read          Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  readAt        DateTime?
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([type])
}

enum NotificationType {
  match_found
  match_accepted
  match_rejected
  shipment_update
  payment_update
  payment_completed
  rating_received
  dispute_opened
  dispute_resolved
  achievement_unlocked
  system_alert
}

// ============================================
// ACHIEVEMENTS & GAMIFICATION
// ============================================

model Achievement {
  id            String   @id @default(cuid())
  code          String   @unique
  name          String
  nameNy        String?  // Chichewa name
  description   String
  descriptionNy String?  // Chichewa description
  category      AchievementCategory
  icon          String
  points        Int      @default(0)
  level         Int?     // Required level (if any)
  
  createdAt     DateTime @default(now())
  
  userAchievements UserAchievement[]
}

enum AchievementCategory {
  milestone
  streak
  community
  seasonal
  route
  earnings
  trips
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  
  unlockedAt    DateTime @default(now())
  progress      Int      @default(0) // Progress towards achievement (0-100)
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

model LeaderboardEntry {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  period        LeaderboardPeriod
  rank          Int
  score         Float
  trips         Int      @default(0)
  earnings      Float    @default(0)
  distance      Float    @default(0) // km
  
  week          Int?     // Week number (for weekly)
  month         Int?     // Month (for monthly)
  year          Int       // Year
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, period, week, month, year])
  @@index([period, year, week, month])
  @@index([rank])
}

enum LeaderboardPeriod {
  weekly
  monthly
  all_time
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id            String   @id @default(cuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  
  action        String
  resource      String
  resourceId    String?
  details       Json?
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

